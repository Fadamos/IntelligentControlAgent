% Author: Adam J Hepworth, Daniel P. Baxter
% LastModified: 2022-08-10
% Explanaton: simulation control script, enabling scenario, behaviour and
% tactic selection. These can be static for the length of the simulation or
% dynamic.

%% Data farming or independent execution

parameters.Adam = false; % set of false for Daniel

%% FOR SINGLE RUN ONLY = TRUE 
parameters.IsolatedSim = true; 

if parameters.IsolatedSim
    close all;
    clc;
    workspace;
end 

%% Complexity pair generation
% used to pick between the 4 levels of sheep-sheep seperation and 4 levels
% of dog speed differential


if parameters.Adam % Adam's isolated simulation parameters 
    parameters.user = "Adam";
    % Sim params 
    parameters.Verbose = false; % visuals (true) or data only (false)
    parameters.VerboseBugger = false; % sys print for increased data debugging
    parameters.visual = "classic"; % 'classic' if using original visuals
    % turn off warnings if not impacting code execution
    warning('off','all')
    warning
    % select either military or classic shepherding visual scenario
    parameters.military = 1; % 0 = classic shepherding; 1+ = military 
    % Context-aware intelligent agent setup
    parameters.NumberOfSheep = 20;
    parameters.NumberOfSteps = (630 + 20 * parameters.NumberOfSheep) * 2;
    % select either military or classic shepherding visual scenario
    parameters.military = 1; % 0 = classic shepherding; 1+ = military 
    if parameters.IsolatedSim
        parameters.CollisionRange = 'L1';
        parameters.SheepDogVehicleSpeedLimit = 'Dog1.5'; %1.5; % If calling this script externally, remove this Scenario selector 
        parameters.DogCollectingTacticIndex = 'F2H';
        parameters.DogDrivingTacticIndex = 'DHH';
        parameters.Replicate = 1; 
    end
    % Markers 
    parameters.OnlineClassifications = 0; % if you want to classify in each time step
    parameters.FullSet = true; 
    parameters.InternalMarkerCalculations = 1; % 1 = observer or 0 = standard simulation
    parameters.WindowSize = 20; % number of observations for each marker window
    parameters.Overlap = 0.5; % proportion of overlap between each marker
    parameters.IntelligentControlAgent = 0; % 1 = intelligent markers agent or 0 = standard simulation 
    parameters.AttentionThreshold = 0.5; % 0.5 = default, else change this. Represents cumsum 
    % Translator 
    parameters.TranslationController = 0; % translation controller (1=true, 0=false)
else % Daniel's isolated simulation parameters 
    parameters.user = "Daniel";
    % Sim params 
    parameters.Verbose = true; % visuals (true) or data only (false)
    parameters.VerboseBugger = true; % sys print for increased data debugging
    if parameters.IsolatedSim
        parameters.CollisionRange = 'L1'; %8; % If calling this script externally, remove this Scenario selector 
        parameters.SheepDogVehicleSpeedLimit = 'Dog1.5'; %1.5; % If calling this script externally, remove this Scenario selector 
        parameters.visual = "classic"; % 'flipped' if using modified visuals
        parameters.DogCollectingTacticIndex = 'F2H';
        parameters.DogDrivingTacticIndex = 'DAH';
        parameters.Replicate = 1; 
    end
    % Markers
    parameters.OnlineClassifications = 0; % if you want to classify in each time step
    parameters.FullSet = true; 
    parameters.InternalMarkerCalculations = 0; % 1 = observer or 0 = standard simulation
    parameters.WindowSize = 50; % number of observations for each marker window
    parameters.Overlap = 0.5; % proportion of overlap between each marker
    parameters.IntelligentControlAgent = 0; % 1 = intelligent markers agent or 0 = standard simulation 
    % Translator 
    parameters.TranslationController = 0; % translation controller (1=true, 0=false) 
    % Context-aware intelligent agent setup
    parameters.NumberOfSheep = 20;
    parameters.NumberOfSteps = (630 + 20 * parameters.NumberOfSheep) * 2;
    % select either military or classic shepherding visual scenario
    parameters.military = 1; % 0 = classic shepherding; 1+ = military 
end

%% Information Marker Calculations
if parameters.IntelligentControlAgent
    % Ensurses that if we use the intelligent decision agent that markers
    % are automatically enabled 
    parameters.InternalMarkerCalculations = 1; 
end
if parameters.InternalMarkerCalculations
     parameters.Windows = WindowSegments(1:parameters.NumberOfSteps,parameters.WindowSize,parameters.Overlap,0,1); % flag for calculating a new marker set <-- do not chagne
end

%% TranslationController
if parameters.TranslationController
    parameters.CollisionRange = SheepSeparationLibrary(parameters.SheepSheepSeparationIndex);
    parameters.SheepDogVehicleSpeedLimit = DogSpeedLibrary(parameters.DogSpeedDifferentialIndex);
end 

%% Evnrionment Setup
parameters.MinX = 0;
parameters.MaxX = 250;
parameters.MinY = 0;
parameters.MaxY = 250;
parameters.Boundary = [parameters.MinX,parameters.MaxX,parameters.MinY,parameters.MaxY];
parameters.SheepInitialCentreOfMass = [0.5*parameters.MaxX, 0.5*parameters.MaxY];

%% Standard Agent Parameters 
parameters.PauseLength = 0.0;
parameters.ActionCommitTime = 1;
parameters.SheepInitialRadius = 150; %100
parameters.SheepInitialGCMx = parameters.MaxX /4;
parameters.SheepInitialGCMy = parameters.MaxY /4;
parameters.SheepInitialClusters = 1;
parameters.NumberOfShepherds = 1;
parameters.SheepDogInitialOffsetFromSheepLocation = 40;
parameters.MaximumSafetyDistance = 1;

% Sheep Behaviours 
parameters.SheepBehaviorModels = ["A1"    "A2"    "A3"    "A4"    "A5"    "A6"    "A7"]; % sheep behaviour identifiers
parameters.SheepStepSize = [1.5 0.75 1.0 1.0 1.0 0.75 1.0]; % s_pi

% Sheepdog Behaviour 
parameters.DrivingCollectingPointsSafetyDistance = 5;
% parameters.SheepDogVehicleSpeedLimit = 1.5; % s_beta **this is now automated selection

% Common Ranges
% parameters.CollisionRange = 4; %2; % 0.4; %MaxX / 40.0; **this is now automated selection
parameters.CohesionRange = 2 * parameters.NumberOfSheep.^(2/3); % the 2* is consistent with Strombom as they didnt change the collision range: parameters.CollisionRange * parameters.NumberOfSheep.^(2/3); 
parameters.AlignmentRange = 0.6 * parameters.NumberOfSheep; %parameters.MaxX / 10.0;
parameters.InfluenceRange = 65; % parameters.MaxX / 10.0; 
parameters.SheepRadius = 2; % r_a 
parameters.Ranges = [parameters.CohesionRange,parameters.AlignmentRange,parameters.InfluenceRange,parameters.SheepRadius];

% DOAT Handling 
parameters.TargetForDOAT = nan;

% Common Weights
parameters.WeightAlignment = 0.1; % 0.0; 
parameters.WeightOfInertia = 0.5; 

% Goal Weights
parameters.GoalX = 15;
parameters.GoalY = 15;
parameters.GoalRadius = 15; %round(sqrt(parameters.NumberOfSheep),0);
parameters.Goal = [parameters.GoalX,parameters.GoalY];

% Sheep Weights - order is A1, A2, A3, A4, A5, A6, A7
parameters.WeightCohesion       = [0.50 1.50 0.50 0.50 1.05 1.05 1.05]; % W_pi_Lambda
parameters.WeightCollision      = [2.00 2.00 3.00 2.00 3.00 1.50 2.00]; % W_pi_pi 
parameters.InfluenceOfDogWeight = [0.50 0.50 1.00 1.90 1.00 1.00 1.00]; % W_pi_beta

%% Scenario Generation 
% used for custom scenario generation with ScenarioIndex 'S0'
parameters.usr = [0    0    1    0    0    0    0]; % all values must = 1; see ScenarioLibrary for examples

if parameters.IsolatedSim
    if parameters.Adam % Adam's isolated simulation parameters 
        parameters.ScenarioIndex = 'S1'; % If calling this script externally, remove this Scenario selector; S5 = Strombom
    else % Daniel's isolated simulation parameters 
        parameters.ScenarioIndex = 'S5'; % If calling this script externally, remove this Scenario selector; S5 = Strombom
    end 
end 

parameters.Scenario = ScenarioLibrary(parameters,parameters.ScenarioIndex);

if parameters.InternalMarkerCalculations
    if parameters.Adam % Adam's isolated simulation parameters 
        load('/Users/ajh/GitHub/RecognitionController/C1.mat')
    else % Daniel's isolated simulation parameters 
        load('C:\Users\danie\OneDrive\Documents\GitHub\RecognitionController\C1.mat')
    end
end

%% Main Function Call
if parameters.InternalMarkerCalculations
     output = SheepMasterWHOLEGroups(parameters, C1);
 else
     output = SheepMasterWHOLEGroups(parameters);
 end
